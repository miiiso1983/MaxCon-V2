@extends('layouts.modern')

@section('page-title', 'ุฅุฏุงุฑุฉ ุงูููุงุชูุฑ')
@section('page-description', 'ุฅุฏุงุฑุฉ ุดุงููุฉ ููููุงุชูุฑ ูุงููุฏููุนุงุช')

@push('head')
<meta name="csrf-token" content="{{ csrf_token() }}">
@endpush

@section('content')
<!-- Page Header -->
<div style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); border-radius: 20px; padding: 30px; margin-bottom: 30px; color: white; position: relative; overflow: hidden;">
    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
    <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
    
    <div style="position: relative; z-index: 2;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <div style="background: rgba(255,255,255,0.2); border-radius: 15px; padding: 15px; margin-left: 20px;">
                        <i class="fas fa-file-invoice" style="font-size: 32px;"></i>
                    </div>
                    <div>
                        <h1 style="font-size: 32px; font-weight: 800; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                            ุฅุฏุงุฑุฉ ุงูููุงุชูุฑ ๐
                        </h1>
                        <p style="font-size: 18px; margin: 5px 0 0 0; opacity: 0.9;">
                            ุฅุฏุงุฑุฉ ุดุงููุฉ ููููุงุชูุฑ ูุงููุฏููุนุงุช ูุน QR Code
                        </p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div style="background: rgba(255,255,255,0.15); border-radius: 25px; padding: 8px 16px; backdrop-filter: blur(10px);">
                        <i class="fas fa-file-invoice" style="margin-left: 8px;"></i>
                        <span style="font-size: 14px; font-weight: 600;">{{ $invoices->total() ?? 0 }} ูุงุชูุฑุฉ</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); border-radius: 25px; padding: 8px 16px; backdrop-filter: blur(10px);">
                        <i class="fas fa-clock" style="margin-left: 8px;"></i>
                        <span style="font-size: 14px;">{{ $statusCounts['sent'] ?? 0 }} ูุฑุณูุฉ</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); border-radius: 25px; padding: 8px 16px; backdrop-filter: blur(10px);">
                        <i class="fas fa-check-circle" style="margin-left: 8px; color: #4ade80;"></i>
                        <span style="font-size: 14px;">{{ $statusCounts['paid'] ?? 0 }} ูุฏููุนุฉ</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); border-radius: 25px; padding: 8px 16px; backdrop-filter: blur(10px);">
                        <i class="fas fa-exclamation-triangle" style="margin-left: 8px; color: #fbbf24;"></i>
                        <span style="font-size: 14px;">{{ $statusCounts['overdue'] ?? 0 }} ูุชุฃุฎุฑุฉ</span>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center;">
                <a href="/tenant/sales/invoices/professional" style="background: rgba(255,255,255,0.2); color: white; padding: 15px 25px; border-radius: 15px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease;"
                   onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)';"
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0)';">
                    <i class="fas fa-plus-circle"></i>
                    ุฅูุดุงุก ูุงุชูุฑุฉ ุงุญุชุฑุงููุฉ
                </a>
                <a href="{{ route('tenant.sales.invoices.create') }}" style="background: rgba(255,255,255,0.15); color: white; padding: 12px 20px; border-radius: 12px; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease; font-size: 14px;"
                   onmouseover="this.style.background='rgba(255,255,255,0.25)'; this.style.transform='translateY(-1px)';"
                   onmouseout="this.style.background='rgba(255,255,255,0.15)'; this.style.transform='translateY(0)';">
                    <i class="fas fa-plus"></i>
                    ุงููุงุชูุฑุฉ ุงูุนุงุฏูุฉ
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="content-card" style="margin-bottom: 25px;">
    <form method="GET" action="{{ route('tenant.sales.invoices.index') }}">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <!-- Search -->
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">ุงูุจุญุซ</label>
                <input type="text" name="search" value="{{ request('search') }}" 
                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;" 
                       placeholder="ุฑูู ุงููุงุชูุฑุฉ ุฃู ุงุณู ุงูุนููู...">
            </div>
            
            <!-- Status Filter -->
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">ุงูุญุงูุฉ</label>
                <select name="status" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    <option value="">ุฌููุน ุงูุญุงูุงุช</option>
                    <option value="draft" {{ request('status') === 'draft' ? 'selected' : '' }}>ูุณูุฏุฉ</option>
                    <option value="sent" {{ request('status') === 'sent' ? 'selected' : '' }}>ูุฑุณูุฉ</option>
                    <option value="viewed" {{ request('status') === 'viewed' ? 'selected' : '' }}>ุชู ุนุฑุถูุง</option>
                    <option value="partial_paid" {{ request('status') === 'partial_paid' ? 'selected' : '' }}>ูุฏููุนุฉ ุฌุฒุฆูุงู</option>
                    <option value="paid" {{ request('status') === 'paid' ? 'selected' : '' }}>ูุฏููุนุฉ</option>
                    <option value="overdue" {{ request('status') === 'overdue' ? 'selected' : '' }}>ูุชุฃุฎุฑุฉ</option>
                    <option value="cancelled" {{ request('status') === 'cancelled' ? 'selected' : '' }}>ููุบูุฉ</option>
                </select>
            </div>
            
            <!-- Customer Filter -->
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">ุงูุนููู</label>
                <select name="customer_id" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    <option value="">ุฌููุน ุงูุนููุงุก</option>
                    @foreach($customers as $customer)
                        <option value="{{ $customer->id }}" {{ request('customer_id') == $customer->id ? 'selected' : '' }}>
                            {{ $customer->name }}
                        </option>
                    @endforeach
                </select>
            </div>
            
            <!-- Date From -->
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">ูู ุชุงุฑูุฎ</label>
                <input type="date" name="date_from" value="{{ request('date_from') }}" 
                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <!-- Date To -->
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">ุฅูู ุชุงุฑูุฎ</label>
                <input type="date" name="date_to" value="{{ request('date_to') }}" 
                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
            </div>
        </div>
        
        <div style="display: flex; gap: 15px;">
            <button type="submit" class="btn-purple" style="padding: 12px 24px;">
                <i class="fas fa-search"></i>
                ุจุญุซ
            </button>
            <a href="{{ route('tenant.sales.invoices.index') }}" class="btn-gray" style="padding: 12px 24px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-times"></i>
                ุฅุนุงุฏุฉ ุชุนููู
            </a>
        </div>
    </form>
</div>

<!-- Invoices Table -->
<div class="content-card">
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f7fafc;">
                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #4a5568; border-bottom: 1px solid #e2e8f0;">ุฑูู ุงููุงุชูุฑุฉ</th>
                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #4a5568; border-bottom: 1px solid #e2e8f0;">ุงูุนููู</th>
                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #4a5568; border-bottom: 1px solid #e2e8f0;">ุชุงุฑูุฎ ุงููุงุชูุฑุฉ</th>
                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #4a5568; border-bottom: 1px solid #e2e8f0;">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</th>
                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #4a5568; border-bottom: 1px solid #e2e8f0;">ุงููุจูุบ ุงูุฅุฌูุงูู</th>
                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #4a5568; border-bottom: 1px solid #e2e8f0;">ุงููุจูุบ ุงููุฏููุน</th>
                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #4a5568; border-bottom: 1px solid #e2e8f0;">ุงูุนููุงุช ุงููุฌุงููุฉ</th>
                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #4a5568; border-bottom: 1px solid #e2e8f0;">ุงูุญุงูุฉ</th>
                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #4a5568; border-bottom: 1px solid #e2e8f0;">ุงูุฅุฌุฑุงุกุงุช</th>
                </tr>
            </thead>
            <tbody>
                @forelse($invoices as $invoice)
                <tr style="transition: all 0.3s ease;" onmouseover="this.style.background='#f7fafc';" onmouseout="this.style.background='white';">
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; color: #2d3748;">{{ $invoice->invoice_number }}</div>
                        <div style="font-size: 12px; color: #718096;">{{ $invoice->type === 'sales' ? 'ูุงุชูุฑุฉ ูุจูุนุงุช' : 'ูุงุชูุฑุฉ ุฃูููุฉ' }}</div>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; color: #2d3748;">{{ $invoice->customer->name }}</div>
                        <div style="font-size: 12px; color: #718096;">{{ $invoice->customer->customer_code }}</div>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <div style="color: #4a5568;">{{ $invoice->invoice_date->format('Y/m/d') }}</div>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <div style="color: #4a5568;">{{ $invoice->due_date->format('Y/m/d') }}</div>
                        @if($invoice->isOverdue())
                            <div style="font-size: 12px; color: #f56565;">ูุชุฃุฎุฑ {{ $invoice->days_overdue }} ููู</div>
                        @endif
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; color: #2d3748;">{{ number_format($invoice->total_amount, 2) }} {{ $invoice->currency }}</div>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; color: #48bb78;">{{ number_format($invoice->paid_amount, 2) }} {{ $invoice->currency }}</div>
                        @if($invoice->remaining_amount > 0)
                            <div style="font-size: 12px; color: #f56565;">ูุชุจูู: {{ number_format($invoice->remaining_amount, 2) }}</div>
                        @endif
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        @if($invoice->free_samples)
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-gift" style="color: #10b981; font-size: 14px;"></i>
                                <span style="font-size: 12px; color: #10b981; font-weight: 600;">ูุชููุฑุฉ</span>
                            </div>
                            <div style="font-size: 11px; color: #718096; margin-top: 2px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ $invoice->free_samples }}">
                                {{ Str::limit($invoice->free_samples, 30) }}
                            </div>
                        @else
                            <span style="font-size: 12px; color: #a0aec0;">ูุง ุชูุฌุฏ</span>
                        @endif
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <span class="status-badge status-{{ $invoice->status_color }}">
                            {{ match($invoice->status) {
                                'draft' => 'ูุณูุฏุฉ',
                                'sent' => 'ูุฑุณูุฉ',
                                'viewed' => 'ุชู ุนุฑุถูุง',
                                'partial_paid' => 'ูุฏููุนุฉ ุฌุฒุฆูุงู',
                                'paid' => 'ูุฏููุนุฉ',
                                'overdue' => 'ูุชุฃุฎุฑุฉ',
                                'cancelled' => 'ููุบูุฉ',
                                'refunded' => 'ูุณุชุฑุฏ',
                                default => $invoice->status
                            } }}
                        </span>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                            <!-- ุนุฑุถ ุงููุงุชูุฑุฉ -->
                            <a href="{{ route('tenant.sales.invoices.show', $invoice) }}"
                               style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; padding: 8px 12px; border-radius: 8px; text-decoration: none; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3); margin: 2px;"
                               title="ุนุฑุถ ุงูุชูุงุตูู"
                               onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(66, 153, 225, 0.4)';"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(66, 153, 225, 0.3)';">
                                <i class="fas fa-eye"></i>
                                <span>ุนุฑุถ</span>
                            </a>

                            <!-- ุนุฑุถ PDF -->
                            <a href="{{ route('tenant.sales.invoices.view-pdf', $invoice) }}"
                               style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white; padding: 8px 12px; border-radius: 8px; text-decoration: none; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(245, 101, 101, 0.3); margin: 2px;"
                               title="ุนุฑุถ PDF"
                               target="_blank"
                               onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(245, 101, 101, 0.4)';"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(245, 101, 101, 0.3)';">
                                <i class="fas fa-file-pdf"></i>
                                <span>PDF</span>
                            </a>

                            <!-- ุชุญููู PDF -->
                            <a href="{{ route('tenant.sales.invoices.pdf', $invoice) }}"
                               style="background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); color: white; padding: 8px 12px; border-radius: 8px; text-decoration: none; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(229, 62, 62, 0.3); margin: 2px;"
                               title="ุชุญููู PDF"
                               onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(229, 62, 62, 0.4)';"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(229, 62, 62, 0.3)';">
                                <i class="fas fa-download"></i>
                                <span>ุชุญููู</span>
                            </a>

                            <!-- ุฅุฑุณุงู ูุงุชุณุงุจ -->
                            @if($invoice->customer->phone)
                            <button onclick="sendWhatsApp({{ $invoice->id }}, '{{ addslashes($invoice->customer->phone) }}', '{{ addslashes($invoice->invoice_number) }}')"
                                    style="background: linear-gradient(135deg, #25d366 0%, #128c7e 100%); color: white; padding: 8px 12px; border-radius: 8px; border: none; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(37, 211, 102, 0.3);"
                                    title="ุฅุฑุณุงู ูุงุชุณุงุจ"
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(37, 211, 102, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(37, 211, 102, 0.3)';">
                                <i class="fab fa-whatsapp"></i>
                                <span>ูุงุชุณุงุจ</span>
                            </button>
                            @endif

                            <!-- ุฅุฑุณุงู ุฅูููู -->
                            @if($invoice->customer->email)
                            <button onclick="showEmailModal({{ $invoice->id }}, '{{ $invoice->customer->email }}')"
                                    style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 8px 12px; border-radius: 8px; border: none; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(72, 187, 120, 0.3);"
                                    title="ุฅุฑุณุงู ุจุงูุฅูููู"
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(72, 187, 120, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(72, 187, 120, 0.3)';">
                                <i class="fas fa-envelope"></i>
                                <span>ุฅูููู</span>
                            </button>
                            @endif

                            <!-- ุชุบููุฑ ุงูุญุงูุฉ -->
                            <button onclick="showStatusModal({{ $invoice->id }}, '{{ $invoice->status }}')"
                                    style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); color: white; padding: 8px 12px; border-radius: 8px; border: none; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(159, 122, 234, 0.3);"
                                    title="ุชุบููุฑ ุงูุญุงูุฉ"
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(159, 122, 234, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(159, 122, 234, 0.3)';">
                                <i class="fas fa-exchange-alt"></i>
                                <span>ุญุงูุฉ</span>
                            </button>
                        </div>
                    </td>
                </tr>
                @empty
                <tr>
                    <td colspan="8" style="padding: 40px; text-align: center; color: #718096;">
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <i class="fas fa-file-invoice" style="font-size: 48px; color: #e2e8f0; margin-bottom: 15px;"></i>
                            <p style="font-size: 18px; font-weight: 600; margin: 0 0 5px 0;">ูุง ุชูุฌุฏ ููุงุชูุฑ</p>
                            <p style="font-size: 14px; margin: 0;">ุงุจุฏุฃ ุจุฅูุดุงุก ูุงุชูุฑุฉ ุฌุฏูุฏุฉ</p>
                        </div>
                    </td>
                </tr>
                @endforelse
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    @if($invoices->hasPages())
    <div style="margin-top: 20px;">
        {{ $invoices->appends(request()->query())->links() }}
    </div>
    @endif
</div>

@push('scripts')
<script>
// Setup CSRF token
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

function showEmailModal(invoiceId, customerEmail) {
    // Implementation for email modal
    if (confirm('ูู ุชุฑูุฏ ุฅุฑุณุงู ุงููุงุชูุฑุฉ ุจุงูุฅูููู ุฅูู: ' + customerEmail + 'ุ')) {
        sendEmail(invoiceId, customerEmail);
    }
}

function sendEmail(invoiceId, email) {
    // Show loading
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุฅุฑุณุงู...';
    button.disabled = true;

    fetch(`/tenant/sales/invoices/${invoiceId}/send-email`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': csrfToken
        },
        body: JSON.stringify({
            email: email
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ุชู ุฅุฑุณุงู ุงููุงุชูุฑุฉ ุจุงูุฅูููู ุจูุฌุงุญ!');
        } else {
            alert('ูุดู ูู ุฅุฑุณุงู ุงูุฅูููู: ' + (data.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุฅูููู: ' + error.message);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function showStatusModal(invoiceId, currentStatus) {
    const statuses = {
        'draft': 'ูุณูุฏุฉ',
        'sent': 'ูุฑุณูุฉ',
        'paid': 'ูุฏููุนุฉ',
        'partial_paid': 'ูุฏููุนุฉ ุฌุฒุฆูุงู',
        'overdue': 'ูุชุฃุฎุฑุฉ',
        'cancelled': 'ููุบูุฉ'
    };

    let options = '';
    for (const [key, value] of Object.entries(statuses)) {
        const selected = key === currentStatus ? 'selected' : '';
        options += `<option value="${key}" ${selected}>${value}</option>`;
    }

    const newStatus = prompt(`ุงูุญุงูุฉ ุงูุญุงููุฉ: ${statuses[currentStatus]}\nุงุฎุชุฑ ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ:\n\n${Object.values(statuses).join('\n')}`);

    if (newStatus && newStatus !== currentStatus) {
        updateStatus(invoiceId, newStatus);
    }
}

function updateStatus(invoiceId, newStatus) {
    fetch(`/tenant/sales/invoices/${invoiceId}/status`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': csrfToken
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ุชู ุชุญุฏูุซ ุญุงูุฉ ุงููุงุชูุฑุฉ ุจูุฌุงุญ!');
            location.reload(); // Refresh the page to show updated status
        } else {
            alert('ูุดู ูู ุชุญุฏูุซ ุงูุญุงูุฉ: ' + (data.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุญุงูุฉ: ' + error.message);
    });
}

// ุฅุฑุณุงู ุงููุงุชูุฑุฉ ุนุจุฑ ูุงุชุณุงุจ
function sendWhatsApp(invoiceId, phone, invoiceNumber) {
    console.log('SendWhatsApp called with:', {invoiceId, phone, invoiceNumber});

    // ุชูุธูู ุฑูู ุงููุงุชู
    let cleanPhone = phone.replace(/[^\d+]/g, '');

    // ุฅุถุงูุฉ ุฑูุฒ ุงูุฏููุฉ ุฅุฐุง ูู ููู ููุฌูุฏุงู
    if (!cleanPhone.startsWith('+')) {
        if (cleanPhone.startsWith('00')) {
            cleanPhone = '+' + cleanPhone.substring(2);
        } else if (cleanPhone.startsWith('0')) {
            cleanPhone = '+964' + cleanPhone.substring(1); // ุงูุนุฑุงู
        } else {
            cleanPhone = '+' + cleanPhone;
        }
    }

    // ุฅูุดุงุก ุฑุณุงูุฉ ุงููุงุชุณุงุจ
    const companyName = '{{ auth()->user()->tenant->name ?? "ุดุฑูุฉ ูุงูุณ ููู" }}';
    const invoiceUrl = `{{ url('/tenant/sales/invoices') }}/${invoiceId}`;

    const message = `ูุฑุญุจุงูุ

ุชู ุฅุตุฏุงุฑ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ ููู ูู ${companyName}

๐ ุฑูู ุงููุงุชูุฑุฉ: ${invoiceNumber}
๐ ุฑุงุจุท ุงููุงุชูุฑุฉ: ${invoiceUrl}

ูููููู ุนุฑุถ ุชูุงุตูู ุงููุงุชูุฑุฉ ูุชุญููููุง ูู ุงูุฑุงุจุท ุฃุนูุงู.

ุดูุฑุงู ูุชุนุงูููู ูุนูุง.`;

    // ุชุฑููุฒ ุงูุฑุณุงูุฉ ููู URL
    const encodedMessage = encodeURIComponent(message);

    // ุฅูุดุงุก ุฑุงุจุท ูุงุชุณุงุจ
    const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;

    // ูุชุญ ูุงุชุณุงุจ ูู ูุงูุฐุฉ ุฌุฏูุฏุฉ
    window.open(whatsappUrl, '_blank');

    // ุชุณุฌูู ุงูุฅุฑุณุงู (ุงุฎุชูุงุฑู)
    console.log('WhatsApp message sent to:', cleanPhone, 'for invoice:', invoiceNumber);
}
</script>
@endpush
@endsection
